services:
  app:
    build: .
    volumes:
      - .:/app
    environment:
      - ENV=development
    command: tail -f /dev/null

  web:
    build: ./web
    working_dir: /app/web
    volumes:
      - .:/app
      - web_node_modules:/app/web/node_modules  # Named volume for container-specific node_modules
      - ${HOME}/.gcp:/app/.gcp:ro
      - ${HOME}/.aws:/root/.aws:ro
    ports:
      - "3000:3000"
    env_file:
      - ./web/.env.local
    command: tail -f /dev/null

  # Playwright test runner - requires web server to be running
  # Usage: make test-e2e (after make web-dev)
  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0-noble
    working_dir: /app/web
    network_mode: host
    volumes:
      - .:/app
      - /app/web/node_modules  # Anonymous volume for container-specific node_modules
    environment:
      - CI=true
    command: npx playwright test --reporter=line

  # E2E test environment - fully self-contained (no host dependencies)
  # Usage: docker-compose run --rm e2e
  # Uses port 3001 internally to avoid conflicts with local dev servers
  # Custom image with pre-cached node_modules and system deps for fast startup
  e2e:
    build:
      context: ./web
      dockerfile: Dockerfile.e2e
    working_dir: /app/web
    volumes:
      - .:/app
      - e2e_node_modules:/app/web/node_modules  # Named volume persists between runs
      - e2e_next_cache:/app/web/.next           # Cache Next.js build output
    environment:
      - CI=true
      - PLAYWRIGHT_TEST=true
      - E2E_TEST_MODE=true
      - NEXTAUTH_URL=http://localhost:3001
      - NEXTAUTH_SECRET=test-secret-for-e2e-testing
      - NEXT_PUBLIC_MOCK_AUTH=true
      - NODE_ENV=production
      - PORT=3001
      - PLAYWRIGHT_BASE_URL=http://localhost:3001
    command: >
      sh -c "
        echo 'ğŸ”§ Installing npm dependencies...' &&
        ./scripts/smart-npm-install.sh &&
        echo 'ğŸ”¨ Building Next.js app...' &&
        npm run build &&
        echo 'ğŸš€ Starting server on port 3001...' &&
        npm start -- --port 3001 &
        echo 'â³ Waiting for server to be ready...' &&
        wait-on http://localhost:3001 --timeout 120000 &&
        echo 'ğŸ­ Running Playwright tests...' &&
        npx playwright test --reporter=line
      "

volumes:
  web_node_modules:
  e2e_node_modules:    # Persists e2e node_modules between test runs
  e2e_next_cache:      # Persists Next.js build cache for faster rebuilds

