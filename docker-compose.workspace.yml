# Docker Compose for isolated workspace: ws-eab0e8
# Generated by workspace-manager.sh - do not edit directly

services:
  web:
    build: ./web
    container_name: strava-ws-ws-eab0e8
    working_dir: /app/web
    volumes:
      - .:/app
      - ws-eab0e8_node_modules:/app/web/node_modules
      - ${HOME}/.gcp:/app/.gcp:ro
      - ${HOME}/.aws:/root/.aws:ro
    ports:
      - "3001:3000"
    env_file:
      - ./web/.env.local
    environment:
      - WORKSPACE_ID=ws-eab0e8
    command: sh -c "./scripts/smart-npm-install.sh && npm run dev"

  # Playwright test runner - requires web server to be running
  # Usage: make test-e2e (after make web-dev)
  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0-noble
    working_dir: /app/web
    network_mode: host
    volumes:
      - .:/app
      - /app/web/node_modules  # Anonymous volume for container-specific node_modules
    environment:
      - CI=true
      - PLAYWRIGHT_BASE_URL=http://localhost:3001
    command: npx playwright test --reporter=line

  # E2E test environment - fully self-contained (no host dependencies)
  # Usage: docker-compose -f docker-compose.workspace.yml run --rm e2e
  # Uses named volumes for caching to speed up subsequent runs
  e2e:
    build:
      context: ./web
      dockerfile: Dockerfile.e2e
    working_dir: /app/web
    volumes:
      - .:/app
      - strava-e2e-node-modules:/app/web/node_modules  # Shared volume persists across workspaces
      - strava-e2e-next-cache:/app/web/.next             # Shared build cache across workspaces
    environment:
      - CI=true
      - PLAYWRIGHT_TEST=true
      - E2E_TEST_MODE=true
      - NEXTAUTH_URL=http://localhost:3001
      - NEXTAUTH_SECRET=test-secret-for-e2e-testing
      - NEXT_PUBLIC_MOCK_AUTH=true
      - NODE_ENV=production
      - PORT=3001
      - PLAYWRIGHT_BASE_URL=http://localhost:3001
    command: >
      sh -c "
        echo 'ğŸ”§ Installing npm dependencies...' &&
        ./scripts/smart-npm-install.sh &&
        echo 'ğŸ”¨ Building Next.js app...' &&
        npm run build &&
        echo 'ğŸš€ Starting server on port 3001...' &&
        npm start -- --port 3001 &
        echo 'â³ Waiting for server to be ready...' &&
        npx wait-on http://localhost:3001 --timeout 120000 &&
        echo 'ğŸ­ Running Playwright tests...' &&
        npx playwright test --reporter=line
      "

volumes:
  ws-eab0e8_node_modules:
  strava-e2e-node-modules:      # Shared across workspaces - persists e2e dependencies
  strava-e2e-next-cache:        # Shared across workspaces - persists Next.js build cache
