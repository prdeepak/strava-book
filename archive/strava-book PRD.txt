# Product Requirements Document (PRD)
**Project Name:** Strava Commemorative Book Generator (Working Title: *MedalBook* [TBC])
**Version:** 1.1
**Status:** Draft

## Current Status (2025-12-29)
- Can log into Strava, pull down activities
- Can generate a "race page" PDF for a single activity -- it's a bit simplistic, but it's a POC
- Have experimented with alternate templates / more dynamic layouts (e.g., scrapbook)

## Next Steps for Development
* Goal: generate a full book, even if it's a bit simplistic
* Square format for print-on-demand compatibility (see Section 7)
* Generate a full table of contents / section titles
* Key overview pages (year at a glance; calendar style?)
* Journal section (one row per activity; dynamic layout based on content available, e.g., map photos, splits, etc.)
* Improved race section; dynamically decide how many pages
* AI-driven race theming with logos and photography (see Section 8)



## 1. Executive Summary
The goal is to build a web application that ingests a user's Strava activity data and programmatically generates a high-quality, print-ready PDF "Yearbook." The output is designed to be a "coffee table" style keepsake, preserving ephemeral digital stats in a tangible, aesthetic format. The user experience prioritizes ease of use (automation) with optional depth of customization.

## 2. Target Audience
* **The Data Nerd:** Loves stats, splits, and heart rate zones.
* **The Sentimentalist:** Wants to preserve memories of a first marathon or a big year of training.
* **The Gifter:** A partner or friend creating a book for an athlete.

## 3. User Flow & Core Features

### Phase 1: Authentication & Ingestion
* **Step 1: Landing & Auth**
    * User lands on homepage.
    * CTA: "Connect with Strava."
    * **Action:** OAuth 2.0 authentication requesting `activity:read_all` and `profile:read_all` scopes.
* **Step 2: The "Waiting Room" (Async Loading)**
    * *System Action:* Backend initiates API calls to fetch user activities, activity streams (lat/long for maps), and profile stats.
    * *User Action:* While data loads, the user is presented with **Global Configuration** options:
        * **Book Title:** (Default: "My [Year] in Review")
        * **Theme/Style:** Select from [x] presets (e.g., *Minimalist B&W*, *Bold/Editorial*, *Technical/Blueprint*).
        * **Unit Preference:** Metric vs. Imperial (Auto-detect from Strava, but allow override).

### Phase 2: Curation (The Builder)
* **Step 3: Book Scope & Table of Contents**
    * **Time Period:** User selects a specific year (e.g., 2023) or a custom date range.
    * **The "Smart Draft":** The system auto-generates a proposed Table of Contents (TOC) based on the data found.
        * *Logic:* If a "Race" tag is found, add a *Race Page*. If data spans Jan-Dec, add *Year in Review*.
    * **Drag & Drop Interface:**
        * **Left Panel (Template Library):** List of available page types (Race, Triathlon, Monthly Log, Heatmap, Best Efforts).
        * **Center Panel (Book View):** The current page order. User can reorder pages, delete pages, or drag new templates in.
        * **Right Panel (Page Config):** When a specific page is selected, contextual options appear (e.g., "Select which race to feature on this page").

### Phase 3: Generation & Delivery
* **Step 4: Rendering**
    * User clicks "Generate Book."
    * System displays a progress bar.
    * *Long-polling fallback:* If generation > 30s, UI updates to: "We are building your book. We will email/text you when it's ready."
* **Step 5: Delivery**
    * User receives a "Download Ready" email.
    * Landing page displays a high-res PDF Viewer.
    * CTA buttons: "Download PDF," "Share," "Edit Book" (takes them back to Phase 2).

## 4. Feature Requirements (The Templates)
*Based on previous designs:*
| Template Name | Data Requirements | Logic |
| :--- | :--- | :--- |
| **Race Section (Run)** | Map (Polyline), Elevation, Splits, Total Time, Date, Title. | User selects specific activity ID. System identifies if photos exist attached to activity. |
| **Year at a Glance** | Daily active/inactive boolean, activity type. | **Visual A:** Calendar Grid. **Visual B:** Streak Heatmap (GitHub style). |
| **Year Graph View** | Monthly distances, Avg Pace vs. HR trends. | Aggregation of all activities within the selected date range. |
| **Best Efforts** | PR data (1k, 5k, 10k, Half, Full). | Compare current period bests vs. all-time bests (if historical data allows). |
| **Full History** | List of *all* activities (Date, Title, Dist, Time). | Paginated list. Likely requires multiple pages for active users. |
| **Route Heatmap** | All polylines for the year overlaid. | Centered on the user's most frequent geolocation. |

## 5. Technical Requirements
* **Strava API:** Strict adherence to rate limits (100 requests/15 min, 1,000/day).
    * *Strategy:* Webhook implementation or aggressive caching. Do not fetch *Streams* (detailed map points) for every activityâ€”only for "Featured" pages (Races) to save API calls. Use summary polylines for the rest.
* **PDF Generation:**
    * Suggested Tech: `React-PDF` (for component-based layout) or `Puppeteer` (headless browser screenshotting) for highest visual fidelity.
* **Map Tiles:**
    * Use Mapbox Static Images API or similar for high-res print-ready map backgrounds. (Strava default maps are often too low-res for print).

---

## 6. UX Enhancements (Suggestions for a Better App)

To make the experience smoother and the product more "premium," consider adding these features to the flow:

### A. The "Smart Highlight" Detector (Crucial for UX)
Don't make the user manually search for their marathon. During the data ingestion phase, write logic to identify:
* **Longest Run:** Auto-suggest a "Race Page" template for this.
* **Fastest 5k:** Auto-suggest a "Best Efforts" callout.
* **Most Active Month:** Auto-suggest a specialized "Month in View" page.
* *Benefit:* The user opens the editor and the book is already 80% perfect.

### B. "Low-Res" Live Preview
Generating a print-quality PDF takes time.
* **The Fix:** Build the book using HTML/Canvas in the browser first. Let the user flip through a digital version instantly. Only generate the heavy PDF when they hit "Finalize." This makes the app feel "instant."

### C. Photo High-Res Uploader
Strava compresses images heavily. If the user wants to print this:
* **Feature:** On the "Race Page" template, allow the user to swap the blurry Strava photo for a high-res upload from their computer camera roll.

### D. The "Foreword" & "Dedication"
A book feels mechanical without text.
* **Feature:** Add a simple text-entry page at the start.
    * *Prompt:* "Write a note to your future self, or describe your main goal for this year."

### E. AI "Art Director" Workflow

**Objective**
Enable users to transform standard data views into bespoke, high-design layouts by leveraging an LLM to act as a "creative director," while maintaining strict security and print-quality standards.

**1. Architectural Strategy: "Configuration, Not Code"**
* **Mechanism:** The AI agent does not generate executable code (HTML/JS) directly, preventing XSS vulnerabilities and styling inconsistencies.
* **Output:** The agent returns a strict **JSON Design Specification** (e.g., `{ "layout": "hero_split", "theme": "vibrant", "hero_image": "img_url" }`).
* **Rendering:** The application parses this JSON and renders the page using a pre-built library of high-quality, print-ready React components.

**2. The 3-Step Generation Workflow**
To ensure the book feels cohesive rather than disjointed, the generation process is hierarchical:
* **Step 1: The Art Director (Global):** The AI analyzes the user's top photos and year summary to generate a **Global Style Guide** (fonts, color palette, motif). This JSON object is passed to all subsequent steps.
* **Step 2: The Narrator (Chapter Level):** Related activities (e.g., "August Training Block") are sent in batches. The AI generates narrative summaries and links the events contextually.
* **Step 3: The Designer (Page or short-section Level):** Individual "Hero" pages or short sections (Races, PRs) are generated by injecting the specific activity data + the Global Style Guide. The AI selects the best photos, crops them (via CSS props), and rewrites captions for emotional resonance.

**3. Data Payload Structure**
Requests to the AI agent (e.g., Claude 3.5 Sonnet or GPT-4o) will include:
* **Context:** Global Style Guide (JSON), Sentiment (e.g., "Celebratory"), Activity Type.
* **Content:** Raw stats, full photo list, original user notes.
* **Constraints:** "Select only 1 photo," "Rewrite text to <20 words."

**4. User Experience**
* **"Beautify" Button:** A single click on a draft page triggers the agent.
* **Smart Defaults:** The system auto-suggests layout types based on data (e.g., if "Marathon" is detected, it suggests a "Poster" layout; if "Training," a "Log" layout).
* **Live Preview:** Users see an instant DOM-based preview of the JSON render before finalizing for PDF generation.

### F. "Print on Demand" Integration (Future Scope)
Eventually, instead of just downloading a PDF, add a "Order Physical Book ($50)" button.
* Integration with an API like Blurb, Lulu, or Gelato.

---

## 7. Print Format & Size Flexibility

### Square Format (Primary)
The book uses a **square format** optimized for print-on-demand photo book services:

| Size | Use Case | Notes |
|------|----------|-------|
| **8" Ã— 8"** | Standard/Economy | Most affordable, good for journals |
| **10" Ã— 10"** | Premium | Ideal balance of impact and cost |
| **12" Ã— 12"** | Large Format | Maximum visual impact, coffee table worthy |

### Print-on-Demand Compatibility
Target compatibility with:
- **Blurb** (Trade Books, Photo Books)
- **Gelato** (Global fulfillment)
- **Lulu** (Self-publishing)

### Technical Implementation: Responsive Templates

**Design Principle:** All templates should be designed at a base size (10" Ã— 10" / 720pt Ã— 720pt) and scale proportionally.

**Approach:**
1. **Base Design Grid:** 720pt Ã— 720pt (10" at 72dpi)
2. **Scale Factor:** Calculate from target size (e.g., 8" = 0.8x, 12" = 1.2x)
3. **Proportional Sizing:** All dimensions use relative units or scale factor
4. **Safe Margins:** Account for bleed (0.125") and trim on all sizes
5. **Font Scaling:** Body text, headers scale proportionally with floor minimums

```typescript
interface BookFormat {
  size: '8x8' | '10x10' | '12x12'
  dimensions: { width: number; height: number }  // in points
  bleed: number
  safeMargin: number
  scaleFactor: number
}

const FORMATS: Record<string, BookFormat> = {
  '8x8':   { width: 576, height: 576, bleed: 9, safeMargin: 36, scaleFactor: 0.8 },
  '10x10': { width: 720, height: 720, bleed: 9, safeMargin: 45, scaleFactor: 1.0 },
  '12x12': { width: 864, height: 864, bleed: 9, safeMargin: 54, scaleFactor: 1.2 },
}
```

**Template Pattern:**
- Templates receive `format: BookFormat` prop
- Use `format.scaleFactor` to adjust font sizes, spacing
- Use percentage-based widths for layout columns
- Test each template at all three sizes

---

## 8. AI-Driven Race Theming & Personalization

### Vision
The book automatically customizes its visual identity based on the user's key races, creating a cohesive "branded" feel that celebrates their achievements.

### 8.1 Race Detection & Hierarchy

**Automatic Race Identification:**
- Detect races via Strava `workout_type` field (Race = 1)
- Identify "A Race" (primary goal race) via:
  - Longest race distance
  - User explicit selection
  - Race with most photos/kudos

**Race Metadata Enrichment:**
- Match race name to known race database (Boston Marathon, NYC Marathon, etc.)
- Fetch race logos, official colors, course photography
- Fall back to location-based imagery (city skylines, landmarks)

### 8.2 Theme Cascade

The book's visual identity flows from the "A Race" down:

```
A Race (e.g., Boston Marathon)
    â†“
Book Cover: Boston Marathon finish line photo, blue/yellow palette
    â†“
Section Dividers: Subtle Boston theming (Citgo sign silhouette, etc.)
    â†“
Race Pages: Each race gets its own mini-theme
    â†“
Journal Pages: Neutral palette that complements A Race colors
```

### 8.3 AI Agent Responsibilities

**Global Style Agent (runs once per book):**
- Analyzes user's A Race and top photos
- Generates global style guide:
  ```json
  {
    "primaryColor": "#0D2240",
    "accentColor": "#FFD200",
    "fontPairing": { "heading": "Oswald", "body": "Source Sans Pro" },
    "motif": "boston-marathon",
    "backgroundStyle": "photo-fade"
  }
  ```

**Race Page Agent (runs per race):**
- Fetches race-specific assets (logo, official photos)
- Selects best user photos for hero placement
- Writes narrative caption with emotional resonance
- Outputs race-specific theme overlay:
  ```json
  {
    "raceId": 12345,
    "heroImage": "user_photo_3.jpg",
    "backgroundImage": "boston_finish_aerial.jpg",
    "logoPlacement": "top-right",
    "accentColor": "#FFD200"
  }
  ```

### 8.4 Human-in-the-Loop Workflow

1. **Auto-Generate:** AI creates initial theme suggestions
2. **Preview:** User sees themed book preview in browser
3. **Adjust:** User can:
   - Change A Race selection
   - Swap photos
   - Override colors/fonts
   - Accept/reject individual race themes
4. **Finalize:** Generate print-ready PDF with approved theme

### 8.5 Asset Sources

**Race Logos & Photos:**
- Partner with race organizations for official assets
- Scrape public race websites (with attribution)
- Use stock photography for generic imagery
- User-uploaded high-res photos

**Fallback Strategy:**
If race-specific assets unavailable:
- Use location photography (city, trail, etc.)
- Generate abstract patterns from route polyline
- Apply user's own best photos as backgrounds

---

=====
# OLD NOTES

## CURRENT STATUS (Updated 2025-12-20)

### âœ… Completed
1. **PDF Generation Modal**: Unified modal for all templates with data selection
2. **Component Extraction**: Reusable components (StatsGrid, Header, CommentsSection, BestEffortsTable)
3. **Data Filtering**: User selections from modal properly filter activity data
4. **Null-Safety**: All templates handle missing data gracefully
5. **Unified Data Fetching**: Single comprehensive-activity-data endpoint

### ðŸ”„ On Hold
- **Art Director Workflow**: Paused for now

### ðŸ“‹ Next Steps

#### 1. AI Font & Color Recommendations
- Test whether AI can intelligently recommend:
  - Fonts for race_1p and race_2p templates
  - Color schemes for race_1p and race_2p templates
- Goal: Personalized styling based on activity data

#### 2. Improve race_2p Template
- Add support for all components selected by user from modal
- Ensure all data elements (photos, comments, splits, laps, best efforts) are displayed when selected
- Currently missing some components that race_1p has

#### 3. Improve race_1p Template  
- Add PhotoGrid component for displaying additional photos (beyond primary)
- Allow user to select which photos to include via modal
- Display selected photos in a grid layout

#### 4. Fix Splits Chart
Priority improvements to splits chart rendering:

**a) Remove Elevation Display**
- Take out elevation profile from splits chart
- Simplify to focus on pace/splits only

**b) Generate PNG Instead of SVG**
- Convert splits chart to PNG generation
- Accept dimensions as parameters from template
- Ensure proper scaling for different sizes

**c) Simplify for Small Renditions**
- If image dimensions are too small:
  - Do not display the black finish flag
  - Identify other components that can be simplified/removed
  - Maintain readability at small sizes

---
### Lessons Learned (December 18, 2024)

**What Worked:**
- Text-based layout descriptions provide good creative guidance
- Google Fonts registration successful - more typography options available
- Two-stage workflow (description â†’ approval â†’ generation) is sound

**What Didn't Work:**
- Free-form AI generation of bodyElements creates messy, overlapping layouts
- No constraints on element placement leads to unprofessional results
- Difficult to ensure print-quality output with unconstrained positioning

### Revised Approach: Template-Based AI Customization

**Core Principle:** Start with proven, professional templates and let AI customize them, rather than generating layouts from scratch.

**Recommended Implementation:**

**Phase 1: Template Library (Immediate)**
1. Keep existing templates (`Race_1p`, `Race_2p`, `Race_graph`) as-is
2. Create new `AIRace_Scrapbook.tsx` template with 2-3 **predefined layout variants**:
   - Variant A: Photo-heavy collage style
   - Variant B: Magazine editorial style
   - Variant C: Minimalist journal style
3. Each variant has **fixed zones** for elements (header, photo grid, stats, narrative)

**Phase 2: AI Customization (Next)**
AI's role is to:
- **Select** which template variant fits the activity best
- **Customize** within constraints:
  - Choose colors from generated palette
  - Select which photos to feature (and in which zones)
  - Pick fonts from registered set
  - Write narrative text
  - Determine stat emphasis
- **Output:** Simple JSON like `{ "template": "scrapbook_variant_a", "colors": {...}, "photos": [0,2], "narrative": "..." }`

**Phase 3: Gradual Enhancement (Future)**
- Add more template variants
- Allow AI to adjust spacing/sizing within zones
- Introduce decorative elements (shapes, borders) with constraints

**Benefits of This Approach:**
- âœ… Predictable, professional results
- âœ… Maintains print quality
- âœ… Easier to debug and iterate
- âœ… User can preview template before AI customization
- âœ… Incremental path to more AI creativity

### Immediate Next Steps

1. **Pause** free-form bodyElements generation
2. **Create** `AIRace_Scrapbook.tsx` with 2-3 fixed layout variants
3. **Simplify** AI role to template selection + parameter customization
4. **Test** with real activities to validate quality

### Alternative Approaches Considered

**Option B: Layout Constraints**
- Define grid system with snap points
- AI can only place elements on grid
- More flexible than templates but still risky

**Option C: Hybrid Approach**
- Use `Race_1p` as base
- Let AI add decorative overlays
- Complex to implement, unclear benefit

**Decision:** Template-based approach (Phase 1-3 above) is the safest, most pragmatic path forward.

### Future Enhancements
(As of 2025-12-14 05:39 EST)
* Establish a default global style guide for the book.  Ensure all PDF pages use the global design



